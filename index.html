<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imposter Game</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Custom styles for a dark, space-themed look */
        body {
            background-color: #1a1a2e; /* Dark purple/blue */
            color: #ffffff;
        }
        .card {
            background-color: #2c2c54; /* Slightly lighter card background */
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.5);
        }
        .btn-primary {
            transition: all 0.2s;
            background-color: #ff6b6b; /* Red accent */
            color: #1a1a2e;
            font-weight: bold;
            box-shadow: 0 4px #e55039;
        }
        .btn-primary:hover {
            background-color: #ff8585;
            box-shadow: 0 2px #e55039;
            transform: translateY(2px);
        }
        .btn-secondary {
            transition: all 0.2s;
            background-color: #48dbfb; /* Blue accent */
            color: #1a1a2e;
            font-weight: bold;
            box-shadow: 0 4px #1e90ff;
        }
        .btn-secondary:hover {
            background-color: #6aefff;
            box-shadow: 0 2px #1e90ff;
            transform: translateY(2px);
        }
        /* Mobile optimization for buttons and inputs */
        input[type="text"], .btn {
            height: 52px;
            font-size: 1.1rem;
        }
    </style>
</head>
<body class="p-4 flex items-center justify-center min-h-screen font-sans">
    
    <div id="app" class="w-full max-w-lg">
        
        <!-- Status Display -->
        <div id="status-message" class="text-center p-3 mb-4 rounded-lg text-sm bg-gray-700 text-gray-300">
            STATUS: Initializing Firebase...
        </div>

        <!-- Main Content Area -->
        <div id="content" class="card p-6 rounded-xl space-y-6">
            <h1 class="text-3xl font-extrabold text-center text-[#ff6b6b]">
                <svg class="inline-block w-8 h-8 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                The Imposter Game
            </h1>

            <!-- Lobby Creation/Joining View -->
            <div id="lobby-view" class="space-y-4">
                <button id="create-lobby-btn" class="w-full btn-primary btn rounded-lg">
                    Create New Lobby
                </button>

                <div class="flex items-center space-x-2 text-gray-400">
                    <hr class="flex-grow border-gray-600">
                    <span class="text-sm">OR JOIN</span>
                    <hr class="flex-grow border-gray-600">
                </div>

                <div class="flex space-x-2">
                    <input type="text" id="join-lobby-id" placeholder="Enter Lobby ID" class="flex-grow p-3 rounded-lg bg-gray-600 text-white placeholder-gray-400 focus:ring-2 focus:ring-[#48dbfb] outline-none">
                    <button id="join-lobby-btn" class="btn-secondary btn px-6 rounded-lg">
                        Join
                    </button>
                </div>
            </div>

            <!-- Game Lobby View -->
            <div id="game-lobby-view" class="hidden space-y-4">
                <h2 class="text-2xl font-bold text-center">Lobby: <span id="current-lobby-id" class="text-[#48dbfb]"></span></h2>
                <p class="text-sm text-gray-400 text-center">Share this ID with friends!</p>
                <div class="text-sm text-center text-gray-500">
                    Your Player ID: <span id="current-user-id" class="break-all font-mono text-xs"></span>
                </div>
                
                <h3 class="text-lg font-semibold mt-4">Players (<span id="player-count">0</span>):</h3>
                <ul id="players-list" class="space-y-2 p-3 rounded-lg bg-gray-700 h-40 overflow-y-auto">
                    <!-- Player names go here -->
                </ul>

                <button id="start-game-btn" class="w-full btn-primary btn rounded-lg mt-4 disabled:opacity-50" disabled>
                    Start Game (Need 3+ Players)
                </button>
                <button id="leave-lobby-btn" class="w-full btn-secondary btn rounded-lg mt-2">
                    Leave Lobby
                </button>
            </div>
        </div>
    </div>
    
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE CONFIGURATION SETUP ---
        
        // Configuration provided by the user (for external deployment/Capacitor)
        const localFirebaseConfig = {
            apiKey: "AIzaSyCWEJOsUXTjdkYPUF_Iz6j5siieTJw5Rs0",
            authDomain: "impostergame-dev.firebaseapp.com",
            projectId: "impostergame-dev",
            storageBucket: "impostergame-dev.firebasestorage.app",
            messagingSenderId: "619697208061",
            appId: "1:619697208061:web:0a62ff8e6a9a701140dc94",
            measurementId: "G-C1HWQ86HV3"
        };
        
        // 1. Get app ID (Canvas variable or fallback to local projectId)
        const appId = typeof __app_id !== 'undefined' ? __app_id : localFirebaseConfig.projectId;
        
        // 2. Get Firebase Config (Canvas variable or fallback to local config)
        let firebaseConfig;
        if (typeof __firebase_config !== 'undefined' && __firebase_config) {
             try {
                firebaseConfig = JSON.parse(__firebase_config);
             } catch (e) {
                console.error("Failed to parse __firebase_config. Falling back to local config.", e);
                firebaseConfig = localFirebaseConfig;
             }
        } else {
             firebaseConfig = localFirebaseConfig;
        }

        // 3. Get Auth Token (Canvas variable or fallback to null)
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        setLogLevel('Debug');
        let app, db, auth;
        let userId = null;
        let currentLobbyId = null;
        let unsubscribeLobby = null;

        // --- UI UTILITIES ---

        const statusEl = document.getElementById('status-message');
        const lobbyViewEl = document.getElementById('lobby-view');
        const gameLobbyViewEl = document.getElementById('game-lobby-view');
        const currentLobbyIdEl = document.getElementById('current-lobby-id');
        const currentUserIdEl = document.getElementById('current-user-id');
        const playersListEl = document.getElementById('players-list');
        const playerCountEl = document.getElementById('player-count');
        const startGameBtn = document.getElementById('start-game-btn');
        const leaveLobbyBtn = document.getElementById('leave-lobby-btn');
        
        function updateStatus(message) {
            statusEl.textContent = `STATUS: ${message}`;
        }
        
        function displayErrorMessage(message) {
             statusEl.textContent = `ERROR: ${message}`;
             statusEl.classList.add('bg-red-700', 'text-red-200');
             setTimeout(() => {
                 statusEl.classList.remove('bg-red-700', 'text-red-200');
                 statusEl.textContent = '';
             }, 5000);
        }

        // --- FIREBASE INITIALIZATION & AUTHENTICATION ---

        async function initializeFirebase() {
            try {
                updateStatus("Initializing Firebase...");
                // Initialize using the determined config
                app = initializeApp(firebaseConfig); 
                db = getFirestore(app);
                auth = getAuth(app);

                // Authenticate user
                updateStatus("Authenticating...");
                if (initialAuthToken) {
                    // Use custom token if available (Canvas environment)
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // Fallback to anonymous sign-in (External environment)
                    await signInAnonymously(auth); 
                }

                // Wait for auth state to resolve
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        updateStatus("Signed in anonymously. Ready to play.");
                        currentUserIdEl.textContent = userId;
                        // Check if the user was in a lobby previously (optional, for robustness)
                    } else {
                        updateStatus("Authentication failed. Critical failure.");
                        console.error("Firebase Init Error: Authentication failed. Critical failure.");
                    }
                });

            } catch (error) {
                updateStatus(`Firebase Initialization Failed: ${error.message}`);
                console.error("Firebase Initialization Failed:", error);
            }
        }

        // --- LOBBY CONFIGURATION ---
        
        // **********************************************
        // * MAX_PLAYERS IS 100 *
        // **********************************************
        const MAX_PLAYERS = 100; 

        const MIN_PLAYERS_TO_START = 3; 

        function getLobbyDocRef(id) {
            return doc(db, `artifacts/${appId}/public/data/lobbies`, id);
        }

        function generateLobbyId() {
            // Generate a simple 4-digit ID
            return Math.random().toString(36).substring(2, 6).toUpperCase();
        }

        // --- LOBBY CREATION & JOINING ---

        async function createLobby() {
            if (!userId) return;

            updateStatus("Creating new lobby...");
            const newLobbyId = generateLobbyId();
            const lobbyRef = getLobbyDocRef(newLobbyId);

            const initialLobbyData = {
                id: newLobbyId,
                status: 'waiting',
                players: [{ id: userId, name: `Player_${userId.substring(0, 4)}`, isHost: true }],
                hostId: userId,
                maxPlayers: MAX_PLAYERS,
                createdAt: new Date().toISOString()
            };

            try {
                await setDoc(lobbyRef, initialLobbyData);
                joinLobby(newLobbyId);
            } catch (error) {
                updateStatus(`Error creating lobby: ${error.message}`);
                displayErrorMessage(`Lobby Creation Error: FirebaseError: ${error.message}`);
                console.error("Lobby Creation Error:", error);
            }
        }

        async function joinLobby(lobbyId) {
            if (!userId || !lobbyId) return;

            const lobbyRef = getLobbyDocRef(lobbyId);

            try {
                const docSnap = await getDoc(lobbyRef);
                
                if (!docSnap.exists()) {
                    displayErrorMessage(`Lobby ${lobbyId} not found.`);
                    return;
                }

                const lobbyData = docSnap.data();

                if (lobbyData.status !== 'waiting') {
                    displayErrorMessage(`Lobby ${lobbyId} has already started.`);
                    return;
                }
                
                // Check if lobby is full using the MAX_PLAYERS setting
                if (lobbyData.players.length >= MAX_PLAYERS) {
                    displayErrorMessage(`Lobby ${lobbyId} is full! Max: ${MAX_PLAYERS}`);
                    return;
                }

                // Add the current player if they aren't already in the list
                if (!lobbyData.players.some(p => p.id === userId)) {
                    const playerName = `Player_${userId.substring(0, 4)}`;
                    const updatedPlayers = [...lobbyData.players, { id: userId, name: playerName, isHost: false }];
                    
                    await updateDoc(lobbyRef, {
                        players: updatedPlayers
                    });
                }

                currentLobbyId = lobbyId;
                enterLobbyView(lobbyId);

            } catch (error) {
                displayErrorMessage(`Error joining lobby: ${error.message}`);
                console.error("Error joining lobby:", error);
            }
        }

        async function leaveLobby() {
            if (!currentLobbyId || !userId) return;

            try {
                const lobbyRef = getLobbyDocRef(currentLobbyId);
                const docSnap = await getDoc(lobbyRef);

                if (docSnap.exists()) {
                    const lobbyData = docSnap.data();
                    const updatedPlayers = lobbyData.players.filter(p => p.id !== userId);

                    if (updatedPlayers.length > 0) {
                        // Update player list and potentially change host
                        const isHost = lobbyData.hostId === userId;
                        const newHostId = isHost ? updatedPlayers[0].id : lobbyData.hostId;

                        await updateDoc(lobbyRef, {
                            players: updatedPlayers,
                            hostId: newHostId
                        });
                    } else {
                        // If no players left, delete the lobby
                        await deleteDoc(lobbyRef);
                    }
                }

            } catch (error) {
                console.error("Error leaving lobby:", error);
                // Continue to exit view even on error
            }

            if (unsubscribeLobby) {
                unsubscribeLobby(); // Stop listening to updates
                unsubscribeLobby = null;
            }
            currentLobbyId = null;
            exitLobbyView();
            updateStatus("Lobby left.");
        }

        // --- REAL-TIME LOBBY LISTENER (onSnapshot) ---
        
        function subscribeToLobby(lobbyId) {
            if (unsubscribeLobby) unsubscribeLobby(); // Clear previous listener

            const lobbyRef = getLobbyDocRef(lobbyId);
            
            unsubscribeLobby = onSnapshot(lobbyRef, (docSnap) => {
                if (docSnap.exists()) {
                    const lobbyData = docSnap.data();
                    renderLobbyDetails(lobbyData);
                } else {
                    // Lobby was deleted (e.g., by the host)
                    if (currentLobbyId === lobbyId) {
                        displayErrorMessage("The lobby was closed by the host.");
                        leaveLobby(); // Clean up client side state
                    }
                }
            }, (error) => {
                console.error("Lobby Snapshot Error:", error);
                displayErrorMessage("Lost connection to the lobby.");
                leaveLobby();
            });
        }
        
        // --- UI RENDERING & EVENT HANDLERS ---

        function enterLobbyView(lobbyId) {
            currentLobbyIdEl.textContent = lobbyId;
            lobbyViewEl.classList.add('hidden');
            gameLobbyViewEl.classList.remove('hidden');
            subscribeToLobby(lobbyId);
            updateStatus(`Joined lobby ${lobbyId}. Waiting for players...`);
        }
        
        function exitLobbyView() {
            lobbyViewEl.classList.remove('hidden');
            gameLobbyViewEl.classList.add('hidden');
            playersListEl.innerHTML = '';
            playerCountEl.textContent = '0';
        }

        function renderLobbyDetails(lobbyData) {
            const players = lobbyData.players || [];
            playersListEl.innerHTML = '';
            playerCountEl.textContent = players.length;

            const isHost = lobbyData.hostId === userId;
            startGameBtn.disabled = !isHost || players.length < MIN_PLAYERS_TO_START;
            
            if (isHost) {
                startGameBtn.textContent = players.length < MIN_PLAYERS_TO_START 
                    ? `Need ${MIN_PLAYERS_TO_START - players.length} more players to start`
                    : 'START GAME';
            } else {
                startGameBtn.textContent = "Waiting for Host to Start...";
            }

            players.forEach(player => {
                const li = document.createElement('li');
                let name = player.name;
                if (player.id === userId) {
                    name += " (You)";
                }
                if (player.id === lobbyData.hostId) {
                    name += " ✨Host";
                }
                
                li.className = 'p-2 rounded-md bg-gray-600 flex justify-between items-center';
                li.textContent = name;
                playersListEl.appendChild(li);
            });
        }

        // --- EVENT LISTENERS ---

        document.getElementById('create-lobby-btn').addEventListener('click', createLobby);
        
        document.getElementById('join-lobby-btn').addEventListener('click', () => {
            const lobbyId = document.getElementById('join-lobby-id').value.trim().toUpperCase();
            if (lobbyId.length > 0) {
                joinLobby(lobbyId);
            } else {
                displayErrorMessage("Please enter a Lobby ID.");
            }
        });
        
        leaveLobbyBtn.addEventListener('click', leaveLobby);
        
        startGameBtn.addEventListener('click', () => {
             // In a real game, this would update the Firestore status to 'started' 
             // and transition all clients to the game screen.
             displayErrorMessage("Game started! (Feature not fully implemented)");
             console.log("Game Start Triggered for Lobby:", currentLobbyId);
        });


        // --- APPLICATION START ---
        
        window.onload = initializeFirebase;

    </script>
</body>
</html>
